name: Validate Content

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema pyyaml markdown

      - name: Validate JSON structure
        run: |
          echo "üîç Validating JSON files..."
          for file in data/**/*.json; do
            echo "Checking $file..."
            if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "‚ùå Invalid JSON: $file"
              exit 1
            fi
          done
          echo "‚úÖ All JSON files are valid"
      
      - name: Validate Markdown frontmatter
        run: |
          echo "üîç Checking Markdown frontmatter..."
          python3 << 'EOF'
          import os
          import re
          import yaml
          
          errors = []
          for root, dirs, files in os.walk('docs'):
              for file in files:
                  if file.endswith('.md'):
                      path = os.path.join(root, file)
                      with open(path, 'r', encoding='utf-8') as f:
                          content = f.read()
                      
                      # Check for frontmatter
                      if content.startswith('---'):
                          match = re.match(r'^---\n(.*?)\n---', content, re.DOTALL)
                          if match:
                              try:
                                  frontmatter = yaml.safe_load(match.group(1))
                                  # Validate required fields
                                  if 'id' not in frontmatter:
                                      errors.append(f"{path}: Missing 'id' in frontmatter")
                              except yaml.YAMLError as e:
                                  errors.append(f"{path}: Invalid YAML - {e}")
          
          if errors:
              print("‚ùå Frontmatter validation errors:")
              for error in errors:
                  print(f"  - {error}")
              exit(1)
          else:
              print("‚úÖ All frontmatter is valid")
          EOF
      
      - name: Check for broken internal links
        run: |
          echo "üîç Checking internal links..."
          python3 << 'EOF'
          import os
          import re
          
          # Collect all markdown files
          md_files = set()
          for root, dirs, files in os.walk('docs'):
              for file in files:
                  if file.endswith('.md'):
                      rel_path = os.path.relpath(os.path.join(root, file), 'docs')
                      md_files.add(rel_path)
          
          # Check links
          errors = []
          for root, dirs, files in os.walk('docs'):
              for file in files:
                  if file.endswith('.md'):
                      path = os.path.join(root, file)
                      with open(path, 'r', encoding='utf-8') as f:
                          content = f.read()
                      
                      # Find markdown links
                      links = re.findall(r'\[.*?\]\((.*?\.md.*?)\)', content)
                      for link in links:
                          # Skip external links
                          if link.startswith('http'):
                              continue
                          
                          # Resolve relative path
                          link_path = link.split('#')[0]  # Remove anchor
                          if link_path.startswith('/'):
                              link_path = link_path[1:]
                          else:
                              link_dir = os.path.dirname(os.path.relpath(path, 'docs'))
                              link_path = os.path.normpath(os.path.join(link_dir, link_path))
                          
                          if link_path and link_path not in md_files:
                              errors.append(f"{path}: Broken link to {link_path}")
          
          if errors:
              print("‚ùå Broken links found:")
              for error in errors:
                  print(f"  - {error}")
              # Don't fail on broken links yet (warning only)
              print("‚ö†Ô∏è Warning: Fix these links eventually")
          else:
              print("‚úÖ No broken links found")
          EOF
      
      - name: Summary
        if: success()
        run: |
          echo "‚úÖ All validation checks passed!"
          echo ""
          echo "üìä Statistics:"
          echo "  - Markdown files: $(find docs -name '*.md' | wc -l)"
          echo "  - JSON files: $(find data -name '*.json' | wc -l)"
          echo "  - Schema files: $(find schemas -name '*.json' 2>/dev/null | wc -l || echo 0)"
